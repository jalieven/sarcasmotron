<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/core-a11y-keys/core-a11y-keys.html">
<link rel="import" href="../components/core-signals/core-signals.html">
<link rel="import" href="../components/paper-toast/paper-toast.html">
<link rel="import" href="../components/paper-fab/paper-fab.html">
<link rel="import" href="../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="sarcasm-card.html">

<polymer-element name="sarcasm-stream" attributes="show stream">
    <template>
        <style>
            :host {
                display: block;
                width: 100%;
            }
            #filter {
                background-color: #fefefe;
                margin-bottom: 30px;
                width: 100%;
                padding: 20px;
            }
            .context {
                opacity: 0.3;
            }
            sarcasm-card {
                margin-bottom: 30px;
            }
            paper-fab.green {
                background: #259b24;
            }
        </style>

        <div layout vertical center>

            <core-a11y-keys target="{{parentElement}}"
                            keys="enter"
                            on-keys-pressed="{{keyHandler}}"></core-a11y-keys>

            <core-signals on-core-signal-sarcasm-favorited="{{handleSarcasmFavorited}}"></core-signals>
            <core-signals on-core-signal-stream-changed="{{handleStreamChanged}}"></core-signals>

            <paper-toast id="favoriteToast" text="Favorite updated!"></paper-toast>
            <paper-toast id="upvoteToast" text="Upvote cast successfully"></paper-toast>
            <paper-toast id="downvoteToast" text="Downvote cast successfully"></paper-toast>

            <div id="filter" layout horizontal>
                <paper-input label="Filter query" value="{{query}}"></paper-input>
                <div flex></div>
                <paper-fab class="green" id="filter-btn" icon="filter-list"
                                   on-click="{{handleFilter}}"></paper-fab>
                <paper-shadow z="1"></paper-shadow>
            </div>

            <template repeat="{{sarcasm in sarcasms}}">

                <sarcasm-card favorite="{{sarcasm.favorite}}"
                              votedUp="{{sarcasm.votedUp}}"
                              votedDown="{{sarcasm.votedDown}}"
                              on-favorited="{{handleFavorite}}"
                              on-vote-up="{{handleVoteUp}}"
                              on-vote-down="{{handleVoteDown}}"
                              on-comment="{{handleComment}}"
                              hidden?="{{show == 'favorites' && !sarcasm.favorite}}">
                    <img src="{{sarcasm.avatar}}" width="70" height="70">
                    <h2>{{sarcasm.user}}</h2>
                    <h4>Votes: {{sarcasm.voteTotal}}</h4>
                    <p class="context"><b>{{sarcasm.timestamp | toHumanReadable}}</b></p>
                    <p>{{sarcasm.quote}}</p>
                    <p class="context" align="right"><i>{{sarcasm.context}}</i></p>
                </sarcasm-card>

            </template>

        </div>

    </template>

    <script>
        Polymer({
            ready: function() {
                var that = this;
                this.stream.fetch({
                    success: function (collection, response, options) {
                        that.sarcasms = collection.toJSON();
                        for (var i = 0; i < that.sarcasms.length; i++) {
                            var sarcasm = that.sarcasms[i];
                            sarcasm.avatar = '../images/avatar-01.svg';
                        }
                    },
                    error: function(collection, response, options) {
                        console.log("Error while fetching sarcasms: " + response);
                    },
                    dataType: "json"});
            },
            handleFavorite: function(event, detail, sender) {
                var that = this;
                var toast = this.$.favoriteToast;
                var sarcasm = sender.templateInstance.model.sarcasm;
                var favoriteModel = this.stream.get(sarcasm.id);
                favoriteModel.favorite({
                    success: function (model, response, options) {
                        toast.show();
                        that.fire('core-signal', {name: "sarcasm-favorited", data: (that.show == 'favorites')});
                    },
                    error: function (model, response, options) {
                        toast.text = "Error while updating favorite!";
                        toast.show();
                    }
                });
            },
            handleVoteUp: function(event, detail, sender) {
                var toast = this.$.upvoteToast;
                console.log("VOTE UP: " + sender.templateInstance.model.sarcasm);
                var sarcasm = sender.templateInstance.model.sarcasm;
                var voteUpModel = this.stream.get(sarcasm.id);
                voteUpModel.voteUp({
                    success: function (model, response, options) {
                        sarcasm.voteTotal += 1;
                        toast.show();
                    },
                    error: function (model, response, options) {
                        if(model.status == 410) {
                            toast.text = model.responseJSON.message;
                            toast.show();
                            sarcasm.votedDown = false;
                            sarcasm.votedUp = false;
                        }
                    }
                });
            },
            handleVoteDown: function(event, detail, sender) {
                var toast = this.$.downvoteToast;
                console.log("VOTE DOWN: " + sender.templateInstance.model.sarcasm);
                var sarcasm = sender.templateInstance.model.sarcasm;

                var voteUpModel = this.stream.get(sarcasm.id);
                voteUpModel.voteDown({
                    success: function (model, response, options) {
                        sarcasm.voteTotal -= 1;
                        toast.show();
                    },
                    error: function (model, response, options) {
                        if(model.status == 410) {
                            toast.text = model.responseJSON.message;
                            toast.show();
                            sarcasm.votedDown = false;
                            sarcasm.votedUp = false;
                        }
                    }
                });
            },
            handleComment: function(event, detail, sender) {
                console.log("COMMENT: " + sender.templateInstance.model.sarcasm);
            },
            toHumanReadable: function(timestamp) {
                return moment(timestamp, "YYYY-MM-DD'T'HH:mm:ss.SSSZ").fromNow()
            },
            handleSarcasmFavorited: function(event, detail, sender) {
                var that = this;
                if((this.show != 'favorites' && detail) || (this.show == 'favorites' && !detail)) {
                    this.stream.fetch({
                        success: function (collection, response, options) {
                            that.stream = collection;
                            that.sarcasms = collection.toJSON();
                            for (var i = 0; i < that.sarcasms.length; i++) {
                                var sarcasm = that.sarcasms[i];
                                sarcasm.avatar = '../images/avatar-01.svg';
                            }
                        },
                        error: function (collection, response, options) {
                            console.log("Error while fetching sarcasms: " + response);
                        },
                        dataType: "json"});
                }
            },
            handleStreamChanged: function(event, detail, sender) {
                this.stream.sort();
                this.sarcasms = this.stream.toJSON();
                for (var i = 0; i < this.sarcasms.length; i++) {
                    var sarcasm = this.sarcasms[i];
                    sarcasm.avatar = '../images/avatar-01.svg';
                }
            },
            handleFilter: function(event, detail, sender) {
                var that = this;
                var query = {'query': this.query};
                var opts = {
                    url: '/sarcasm/search',
                    success: function (collection, response, options) {
                        that.fire('core-signal',
                                {name: "stream-changed", data: collection}
                        );
                        console.log("Success while searching sarcasms: " + response);
                    },
                    error: function(collection, response, options) {
                        console.log("Error while searching sarcasms: " + response);
                    },
                    data: $.param(query),
                    dataType: "json"};

                this.stream.fetch(opts);
            },
            keyHandler: function(event, detail, sender) {
                switch (detail.key) {
                    case 'enter':
                        this.handleFilter(event, detail, sender);
                        break;

                }
            }
        });
    </script>

</polymer-element>
