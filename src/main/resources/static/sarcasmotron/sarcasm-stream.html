<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/core-signals/core-signals.html">
<link rel="import" href="../components/paper-toast/paper-toast.html">
<link rel="import" href="sarcasm-card.html">

<polymer-element name="sarcasm-stream" attributes="show">
    <template>
        <style>
            :host {
                display: block;
                width: 100%;
            }
            .context {
                opacity: 0.3;
            }
            sarcasm-card {
                margin-bottom: 30px;
            }
        </style>

        <div layout vertical center>

            <core-signals on-core-signal-sarcasm-added="{{handleSarcasmAdded}}"></core-signals>
            <core-signals on-core-signal-sarcasm-favorited="{{handleSarcasmFavorited}}"></core-signals>

            <paper-toast id="favoriteToast" text="Favorite updated!"></paper-toast>
            <paper-toast id="upvoteToast" text="Upvote cast successfully"></paper-toast>
            <paper-toast id="downvoteToast" text="Downvote cast successfully"></paper-toast>

            <template repeat="{{sarcasm in sarcasms}}">

                <sarcasm-card favorite="{{sarcasm.favorite}}"
                              votedUp="{{sarcasm.votedUp}}"
                              votedDown="{{sarcasm.votedDown}}"
                              on-favorited="{{handleFavorite}}"
                              on-vote-up="{{handleVoteUp}}"
                              on-vote-down="{{handleVoteDown}}"
                              on-comment="{{handleComment}}"
                              hidden?="{{show == 'favorites' && !sarcasm.favorite}}">
                    <img src="{{sarcasm.avatar}}" width="70" height="70">
                    <h2>{{sarcasm.user}}</h2>
                    <p class="context"><b>{{sarcasm.timestamp | toHumanReadable}}</b></p>
                    <p>{{sarcasm.quote}}</p>
                    <p class="context" align="right"><i>{{sarcasm.context}}</i></p>
                </sarcasm-card>

            </template>

        </div>

    </template>

    <script>
        Polymer({
            ready: function() {
                var that = this;

                var originalSync = Backbone.sync;
                Backbone.sync = function(method, model, options) {
                    options.headers = options.headers || {};
                    _.extend(options.headers, { "openamssoid" : getSSOToken()});
                    originalSync.call(model, method, model, options);
                };

                var SarcasmModel = Backbone.Model.extend({
                    urlRoot: '/sarcasm',
                    favorite: function(opts) {
                        var model = this, url = model.url() + '/favorite',
                                options = {url: url, type: 'POST'};
                        _.extend(options, opts);
                        return (this.sync || Backbone.sync).call(this, null, this, options);
                    },
                    voteUp: function(opts) {
                        var model = this, url = model.url() + '/upvote',
                                options = {url: url, type: 'POST'};
                        _.extend(options, opts);
                        return (this.sync || Backbone.sync).call(this, null, this, options);
                    },
                    voteDown: function(opts) {
                        var model = this, url = model.url() + '/downvote',
                                options = {url: url, type: 'POST'};
                        _.extend(options, opts);
                        return (this.sync || Backbone.sync).call(this, null, this, options);
                    }
                });
                var SarcasmCollection = Backbone.Collection.extend({
                    model: SarcasmModel,
                    url: '/sarcasm',
                    comparator: function (a, b) {
                        var one = moment(a.get("timestamp"), "YYYY-MM-DD'T'HH:mm:ss.SSSSZ");
                        var two = moment(b.get("timestamp"), "YYYY-MM-DD'T'HH:mm:ss.SSSSZ");
                        if(one.isAfter(two)) {
                            return -1;
                        } else {
                            return 1;
                        }
                    }
                });
                this.sarcasmsModel = new SarcasmCollection();
                this.sarcasmsModel.fetch({
                    success: function (collection, response, options) {
                        that.collection = collection;
                        that.sarcasms = collection.toJSON();
                        for (var i = 0; i < that.sarcasms.length; i++) {
                            var sarcasm = that.sarcasms[i];
                            sarcasm.avatar = '../images/avatar-01.svg';
                        }
                    },
                    error: function(collection, response, options) {
                        console.log("Error while fetching sarcasms: " + response);
                    },
                    dataType: "json"});
            },
            handleFavorite: function(event, detail, sender) {
                var that = this;
                var toast = this.$.favoriteToast;
                var sarcasm = sender.templateInstance.model.sarcasm;
                var favoriteModel = this.collection.get(sarcasm.id);
                favoriteModel.favorite({
                    success: function (model, response, options) {
                        toast.show();
                        that.fire('core-signal', {name: "sarcasm-favorited", data: model});
                    },
                    error: function (model, response, options) {
                        console.log("Error favoriting")
                    }
                });
            },
            handleVoteUp: function(event, detail, sender) {
                var toast = this.$.upvoteToast;
                console.log("VOTE UP: " + sender.templateInstance.model.sarcasm);
                var sarcasm = sender.templateInstance.model.sarcasm;
                var voteUpModel = this.collection.get(sarcasm.id);
                voteUpModel.voteUp({
                    success: function (model, response, options) {
                        toast.show();
                    },
                    error: function (model, response, options) {
                        if(model.status == 410) {
                            toast.text = model.responseJSON.message;
                            toast.show();
                            sarcasm.votedDown = false;
                            sarcasm.votedUp = false;
                        }
                    }
                });
            },
            handleVoteDown: function(event, detail, sender) {
                var toast = this.$.downvoteToast;
                console.log("VOTE DOWN: " + sender.templateInstance.model.sarcasm);
                var sarcasm = sender.templateInstance.model.sarcasm;
                var voteUpModel = this.collection.get(sarcasm.id);
                voteUpModel.voteDown({
                    success: function (model, response, options) {
                        toast.show();
                    },
                    error: function (model, response, options) {
                        if(model.status == 410) {
                            toast.text = model.responseJSON.message;
                            toast.show();
                            sarcasm.votedDown = false;
                            sarcasm.votedUp = false;
                        }
                    }
                });
            },
            handleComment: function(event, detail, sender) {
                console.log("COMMENT: " + sender.templateInstance.model.sarcasm);
            },
            toHumanReadable: function(timestamp) {
                return moment(timestamp, "YYYY-MM-DD'T'HH:mm:ss.SSSZ").fromNow()
            },
            handleSarcasmAdded: function(event, detail, sender) {
                var that = this;
                this.sarcasmsModel.create(detail,
                        {
                            wait : true,
                            success : function(model, response, options){
                                console.log("Sarcasm Added!!!!");
                                that.collection.sort();
                                that.sarcasms = that.collection.toJSON();
                                for (var i = 0; i < that.sarcasms.length; i++) {
                                    var sarcasm = that.sarcasms[i];
                                    sarcasm.avatar = '../images/avatar-01.svg';
                                }
                            },
                            error : function(err) {
                                console.log("Fail saving sarcasm: " + err);
                            }
                        });
            },
            handleSarcasmFavorited: function(event, detail, sender) {
                var that = this;
                this.sarcasmsModel.fetch({
                    success: function (collection, response, options) {
                        that.collection = collection;
                        that.sarcasms = collection.toJSON();
                        for (var i = 0; i < that.sarcasms.length; i++) {
                            var sarcasm = that.sarcasms[i];
                            sarcasm.avatar = '../images/avatar-01.svg';
                        }
                    },
                    error: function(collection, response, options) {
                        console.log("Error while fetching sarcasms: " + response);
                    },
                    dataType: "json"});
            }
        });
    </script>

</polymer-element>
